# ansible-playbook apply_es_cluster.yml -e target_name=jlabs-pp -e target_region=eu-west-1
---
- hosts: "{{ target|default('es_instances') }}"
  become: yes
  # serial: 1
  vars_files:
    - "../../{{ target_name }}/inventories/group_vars/es_config.yml"
  pre_tasks:
    - debug:
        msg: "{{ hostvars[groups['es_instances'][0]].ansible_default_ipv4.address }}:9300"
    - apt_repository:
        repo: "deb http://httpredir.debian.org/debian jessie-backports main contrib non-free"
        update_cache: yes
    - set_fact:
        cluster_alias: "es"
  roles:
    - role: es-role
      vars:
        es_instance_name: "{{ inventory_hostname }}"
        es_config:
          node.name: "{{ inventory_hostname }}"
          cluster.name: "{{ cluster_name }}"
          node.data: "{{ es_node_data }}"
          node.master: "{{ es_node_master }}"
          node.ingest: "{{ es_node_ingest }}"
          discovery.zen.ping.unicast.hosts: "{{ hostvars[groups['es_instances_masters'][0]].ansible_default_ipv4.address }}:9300"
          network.host: "{{ ansible_default_ipv4.address }}"
          transport.tcp.port: 9300
        es_api_host: "{{ ansible_default_ipv4.address }}"
        es_api_port: 9200

  tasks:
    - name: add stopwords file
      copy:
        src: "{{ playbook_dir }}/../../files/stopwords.txt"
        dest: "{{ es_conf_dir }}/stopwords.txt"
      tags: additionals
