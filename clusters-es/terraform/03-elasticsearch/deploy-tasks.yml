---
- blockinfile:
    path: "{{ playbook_dir }}/../../{{ target_name }}-ssh.cfg"
    create: yes
    marker: '# {mark} ES'
    insertafter: "# END BASTION"
    block: |
      {% for instance in all_terraform_outputs.es_instance_masters_list.value %}
      Host es-instance-master-{{ loop.index0 }} {{ instance }}
        Hostname {{ instance }}
        StrictHostKeyChecking no
        ProxyCommand ssh -t -F ./{{ target_name }}-ssh.cfg -W %h:%p BASTION_AWS
        User admin
        IdentityFile ~/.ssh/{{ target_name }}-aws-bastion
      {% endfor %}

      {% for instance in all_terraform_outputs.es_instance_workers_list.value %}
      Host es-instance-worker-{{ loop.index0 }} {{ instance }}
        Hostname {{ instance }}
        StrictHostKeyChecking no
        ProxyCommand ssh -t -F ./{{ target_name }}-ssh.cfg -W %h:%p BASTION_AWS
        User admin
        IdentityFile ~/.ssh/{{ target_name }}-aws-bastion
      {% endfor %}
