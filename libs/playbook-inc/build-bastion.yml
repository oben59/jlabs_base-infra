---
## BASTION
- name: Extract the public IP generated by Terraform for the bastion
  shell: >-
    terraform output bastion_asg
  args:
    chdir: "{{ playbook_dir }}/../../terraform/{{ layer_name }}"
  register: tf_bastion_raw
  changed_when: no

- name: Register variables recieved from Terraform
  set_fact:
    bastion_asg_name: "{{ tf_bastion_raw.stdout }}"

- ec2_asg_facts:
    name: "{{ bastion_asg_name }}"
    region: "{{ target_region }}"
  register: asg_detailed

- ec2_remote_facts:
    filters:
      instance-id: >-
        {{
          asg_detailed.results[0].instances
          |map(attribute='instance_id')
          |list
        }}
    region: "{{ target_region }}"
  register: ec2_partners_detailed

- set_fact:
    bastion_ip: >-
      {{
        (
          ec2_partners_detailed.instances
          |map(attribute='public_ip_address')
          |list
        )[0]
      }}


# Host configuration for current layers
- blockinfile:
    path: "{{ playbook_dir }}/../../{{ target_name }}/inventories/hosts_{{ layer_name }}"
    create: yes
    marker: '# {mark} BASTION'
    block: |
      [bastion]
      BASTION_AWS
- blockinfile:
    path: "{{ playbook_dir }}/../../{{ target_name }}-ssh.cfg"
    create: yes
    marker: '# {mark} BASTION'
    block: |
      Host BASTION_AWS {{ bastion_ip }}
        Hostname {{ bastion_ip }}
        StrictHostKeyChecking no
        User admin
        IdentityFile ~/.ssh/{{ target_name }}-aws-bastion


# Host configuration for Nomad layers
- blockinfile:
    path: "{{ playbook_dir }}/../../../clusters-nomad/{{ target_name }}/inventories/hosts_parent_{{ layer_name }}"
    create: yes
    marker: '# {mark} BASTION'
    block: |
      [bastion]
      BASTION_AWS
- blockinfile:
    path: "{{ playbook_dir }}/../../../clusters-nomad/{{ target_name }}-ssh.cfg"
    create: yes
    marker: '# {mark} BASTION'
    block: |
      Host BASTION_AWS {{ bastion_ip }}
        Hostname {{ bastion_ip }}
        StrictHostKeyChecking no
        User admin
        IdentityFile ~/.ssh/{{ target_name }}-aws-bastion
