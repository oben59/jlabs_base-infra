---
- hosts: "localhost"
  any_errors_fatal: true
  become: yes

  vars:
    # TMP for tests..
    secrets_dir: "{{ playbook_dir }}/../../secrets/{{ target_name }}-ctn-{{ target_region }}"
    target_name: jlabs-pp
    target_region: eu-west-1
    nomad:
      svc_api:
        count: 1
        max_parallel: 1
        cpu: 400
        memory: 400

  # ---
  vars_files:
    - "../../{{ secrets_dir }}/docker-env/commons.yml"
    - "../../{{ secrets_dir }}/docker-env/node-config.yml"

  tasks:
    - name: format docker env config parameters to integrate them in nomad configuration
      set_fact:
        node_config: "{{ node_config | to_json | regex_replace('\"', '\\\"') | regex_replace(', ', ',') | regex_replace(': ', ':') }}"
        node_debug: "{{ node_debug | to_json | regex_replace('\"', '\\\"') | regex_replace(', ', ',') | regex_replace(': ', ':') }}"
  # ---

    - name: node_config
      debug:
        msg: "{{ node_config }}"
    - name: node_debug
      debug:
        msg: "{{ node_debug }}"


    - template:
        src: "./nomad/jobs/svc-api/svc-api.hcl.j2"
        dest: "./test.hcl"

